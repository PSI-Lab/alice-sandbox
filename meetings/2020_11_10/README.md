

## Compare FE

For predicted best global structure not equal to ground truth,
calculate FE and compare with ground truth.


```
python compare_fe.py ../2020_10_13/data/rand_s1_bb_0p1_global_structs_60.pkl.gz data/rand_s1_bb_0p1_global_structs_60_fe.pkl.gz
```


Result:

- Total: 45885

- With negative free energy (as defined by RNAfold): 32008

![plot/compare_fe.png](plot/compare_fe.png)

- Above plot: comparing FE for all sequences where pred_fe < 0 (as defined by RNAfold)

![plot/compare_fe_wo_perfect_hits.png](plot/compare_fe_wo_perfect_hits.png)

- Above plot: after removing perfect hits (pred struct == RNAfold MFE struct).

- Interestingly, there are also cases where pred_fe < rnafold_fe.
Note that this means the RNAfold struct is not MFE. Not sure why this can happen.

```
FE: rnafold -1.8, pred -4.2
GUCUCUUCAUGGAAGGUCACGU length 22
...(((((...)))))...... [RNAfold]
(((.((((...))))))).... [pred]

FE: rnafold -9.8, pred -10.5
AUCUAAAAGGAGAACGCAUCCAACAAGUCGGAGGGGCAUCCUAC length 44
.......((((...(.(.(((........)))).)...)))).. [RNAfold]
.......((((...(((.(((........))))))...)))).. [pred]

FE: rnafold -3.7, pred -7.2
AUAAACGGCGAAGGUUAGGCAAUGAUCUAGGGGGU length 35
........(..((((((.....))))))..).... [RNAfold]
....((.((..((((((.....))))))..)).)) [pred]

FE: rnafold -1.3, pred -1.4
GGUCACACAGCACGGUAGCGAUAAGGUU length 28
.(((.(((......)).).)))...... [RNAfold]
.(((((...((...)).)))))...... [pred]

FE: rnafold -6.9, pred -8.8
AUCCAUCCCUGCGUAGAUCUUAUUCCAGGGCUC length 33
......(((((.(((.....)))..)))))... [RNAfold]
......(((((.(((((...))))))))))... [pred]

FE: rnafold -16.6, pred -17.1
CCAUUUUCGCCACGGCACAUCCUGGGCGGUGGCGAUCGACGCAGCCCUACACAACG length 56
......(((((((.((.((...)).)).)))))))..................... [RNAfold]
......(((((((.((.((....)))).)))))))..................... [pred]

FE: rnafold -10.4, pred -11.1
GCACAAUUAUUAGGGGGGGGAGCGAUAGAUACGGAGUCGCACGCAUUCUCAA length 52
............((((((.(.(((((.........))))).).).))))).. [RNAfold]
............((((((((.(((((.........))))).))).))))).. [pred]

FE: rnafold -1.5, pred -2.9
GUUCUGGUGCUAAGGCUGCGUA length 22
......((((....)).))... [RNAfold]
.....(((((....)))))... [pred]

FE: rnafold -2.9, pred -5.7
GGUCGAUACGCAGCAUCAAGUUUGGUUUCU length 30
....((.((..(((.....)))..)).)). [RNAfold]
....((.((.((((.....)))).)).)). [pred]
```

As an example, the first sequence:

![plot/example_lower_fe_pred.png](plot/example_lower_fe_pred.png)

Note that both standard and non-standard base pairs exist in the prediction.
(But RNAfold FE computation seems to be OK with it. I think it's using the
full 4x4 stack base pair FE table)

Generated by [plot_fe.ipynb](plot_fe.ipynb)


## Debug stage 1 training

Typo:

https://github.com/PSI-Lab/alice-sandbox/blob/ea338fddfd63358e2b160910773e65a758e4042c/meetings/2020_08_25/train_simple_conv_net_pixel_bb_all_targets.py#L191

Fix:

```
# old
'iloop_location_y': torch.from_numpy(target_hloop_location_y[:, :, np.newaxis]).float(),

# fixed
'iloop_location_y': torch.from_numpy(target_iloop_location_y[:, :, np.newaxis]).float(),
```

Updated script: [train_simple_conv_net_pixel_bb_all_targets.py](train_simple_conv_net_pixel_bb_all_targets.py)


Training:

```
CUDA_VISIBLE_DEVICES=0 python train_simple_conv_net_pixel_bb_all_targets.py --data ZQi8RT --result result/rf_data_all_targets_3 --num_filters 32 32 64 64 64 128 128 --filter_width 9 9 9 9 9 9 9 --epoch 50 --mask 0.1 --batch_size 40 --max_length 200 --cpu 12
```

Model uploaded:

TODO




plot: TODO

<!--plot_training.py from https://github.com/PSI-Lab/alice-sandbox/tree/master/meetings/2020_09_15-->



<!--eval bb pred: TODO-->

<!--eval_model_dataset.py  from https://github.com/PSI-Lab/alice-sandbox/tree/master/meetings/2020_09_22-->


<!--run stage 1 model: TODO-->

<!--run_predictor_bb.py from https://github.com/PSI-Lab/alice-sandbox/tree/master/meetings/2020_09_22-->

global assembly util TODO
https://github.com/PSI-Lab/alice-sandbox/tree/master/meetings/2020_10_13

pipeline global struct: TODO


move all to a top level util: TODO

end-to-end pipeline on single seq? on dataset?


## End-to-end predictive workflow

Stage 1 - predict bounding boxes:

```
from model_utils.utils_model import Predictor
model = Predictor('v0.1')
stems, iloops, hloops = model.predict_bb('GUUCUGGUGCUAAGGCUGCGUA', threshold=0.1)
```

Stage 2 - global structure assembly (following above step):


```
from model_utils.util_global_struct import make_bb_df, generate_structs
df_stem, df_iloop, df_hloop = make_bb_df(stems, iloops, hloops, min_pixel_pred=3, min_prob=0.5)
df_global_structs = generate_structs(df_stem, df_iloop, df_hloop)
```

Scoring:

TODO


## TODOs

move to top level util

end to end pipeline


Heuristics: More structure is better -> if global struct A is subset of B, discard A

For predicted best global structure not equal to ground truth, calculate FE and compare with ground truth

Debug stage 1 iloop data

Pseudo knot?

RNA-RNA interaction? Run stage 1 model three times, A-A, B-B & A-B, 2nd stage will have different constraints

Evaluate on another dataset? rfam151?

Long sequence?

Greedy approach of assembly? Start with high prob bounding boxes, terminate after explored say 100 global structures?

size > 10



